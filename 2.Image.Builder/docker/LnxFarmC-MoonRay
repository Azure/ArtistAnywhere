FROM xstudio.azurecr.io:lnx-farmc-cmake

WORKDIR /usr/local/src

# RUN dnf -y install 'dnf-command(config-manager)' &&\
#     dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/cuda-rhel9.repo &&\
#     dnf -y install cuda

RUN source /usr/local/src/functions.sh &&\
    git clone --recurse-submodules https://github.com/dreamworksanimation/openmoonray.git &&\
    source openmoonray/building/Rocky9/install_packages.sh --nocuda

WORKDIR openmoonray/build

RUN source /usr/local/src/functions.sh &&\
    StartProcess "cmake ../building/Rocky9" openmoonray-prereqs &&\
    StartProcess "cmake --build . -- -j $(nproc)" openmoonray-prereqs

RUN rm -rf * &&\
    StartProcess "cmake .. -DPYTHON_EXECUTABLE=python3 -DBOOST_PYTHON_COMPONENT_NAME=python39 -DABI_VERSION=0 -DMOONRAY_USE_CUDA=NO" openmoonray-build &&\
    StartProcess "cmake --build . -- -j $(nproc)" openmoonray-build &&\
    mkdir /usr/local/openmoonray &&\
    StartProcess "cmake --install . --prefix /usr/local/openmoonray" openmoonray-build

ENV PATH=$PATH:/usr/local/openmoonray

CMD source /usr/local/openmoonray/scripts/setup.sh
